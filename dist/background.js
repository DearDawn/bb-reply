(()=>{let e=new class{constructor(){this.messageApi="https://api.bilibili.com/x/msgfeed/reply",this.cookie="",this.cookieMap={},this.messageList=[],this.count=0,this.cursor={is_end:!1,id:void 0,time:void 0}}async init(){let e=await chrome.cookies.getAll({});console.log("[dodo] ","cookieList",e),this.cookieMap=e.reduce((e,o)=>(e[o.name]=o.value,e),{});let o=e.map(e=>`${e.name}=${e.value}`).join("; ");this.cookie=o,this.getMessageList()}getMessageUrl(){let e=new URLSearchParams({platform:"web",build:"0",mobi_app:"web"});return this.cursor.id&&this.cursor.time&&(e.append("cursor",this.cursor.id.toString()),e.append("time",this.cursor.time.toString())),console.log("[dodo] ","`${this.messageApi}?${params.toString()}`",`${this.messageApi}?${e.toString()}`),`${this.messageApi}?${e.toString()}`}async getMessageList(){let e=await fetch(this.getMessageUrl(),{headers:{Cookie:this.cookie}}),o=await e.json();console.log("[dodo] ","data",o),0===o.code&&(this.messageList=o.data.items,this.cursor=o.data.cursor)}async sendReply(){let e=this.messageList[0];console.log("[dodo] ","latestItem",e);let{item:o,user:t}=e||{},{nickname:i}=t||{},{subject_id:s,root_id:a,source_id:n}=o||{},r=this.cookieMap.bili_jct;fetch("https://www.dododawn.com:7020/api/proxy",{method:"POST",headers:{"content-type":"application/json"},credentials:"include",body:JSON.stringify({url:"https://api.bilibili.com/x/v2/reply/add",init:{method:"POST",headers:{"content-type":"application/x-www-form-urlencoded",Accept:"application/json, text/plain, */*",Cookie:this.cookie,Origin:"https://message.bilibili.com",Referer:"https://message.bilibili.com/","User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/127.0.0.0 Safari/537.36"},body:new URLSearchParams({oid:s,type:"1",message:`\u{56DE}\u{590D} @${i} :\u{56DE}\u{590D}\u{4E00}\u{4E0B}\u{770B}\u{770B}, ${Date.now().toLocaleString()}`,root:a,parent:n,jsonp:"jsonp",scene:"msg",plat:"1",from:"im-reply",build:"0",mobi_app:"web",csrf:r,csrf_token:r}).toString()}})}).then(e=>e.json()).then(e=>{console.log("[dodo] ","reply res",e),chrome.runtime.sendMessage({source:"background",action:"replyDone",res:{code:0}})})}};chrome.tabs.onActivated.addListener(function(e){console.log("Activated Tab ID:",e.tabId)}),chrome.runtime.onMessage.addListener(o=>{let{source:t,action:i}=o||{};return console.log("[dodo] ","content ready",t,i),"content"===t?"ready"===i&&e.init():"popup"===t&&("ready"===i?(console.log("[dodo] ","popup ready"),chrome.runtime.sendMessage({source:"background",action:"ready",cookie:e.cookie})):"bbReply"===i&&e.sendReply()),!1})})();
//# sourceMappingURL=background.js.map
